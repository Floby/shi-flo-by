var net = require('net')
var request = require('request')


var Model = require('../model')

var m = new Model()
var n = new Model()
var open = true
var server = net.createServer(function (stream) {
  stream.pipe(
    m.createStream()
    .on('error', function (err) {
      stream.destroy()

      if(open) server.close(), open = false
    })
  ).pipe(stream)
}).listen(9999)

var stream = request('http://localhost:9999')

var ns = n.createStream()
stream.on('error', function (err) {
  stream.destroy(); ns.destroy()
  console.log('expected error:', err.toString())
}).pipe(ns).pipe(stream)
